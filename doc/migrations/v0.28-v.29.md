<!--Specify versions for migration below-->
# Migrating to libp2p@__

A migration guide for refactoring your application code from libp2p v0.28.x to v0.29.0.

## Table of Contents

- [API](#api)
  - [Pubsub](#pubsub)
  - [Uint8Arrays replace node Buffers](#uint8arrays-replace-node-buffers)
- [Module Updates](#module-updates)

## API

### Pubsub

The [`libp2p-gossipsub`](https://github.com/ChainSafe/js-libp2p-gossipsub) javascript implementation is now upgraded according to the Gossipsub v1.1 [spec](https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md) and it packs several security hardening extensions. You can read more about it in its [blogpost](https://blog.ipfs.io/2020-05-20-gossipsub-v1.1/).

We leveraged this update to rethink the pubsub interface, in order to make it easier, as well as to be consistent with the API of the routers. Moreover, the interface was also reconstructed to ease new pubsub router implementations.

#### Access router instance

Libp2p prior to 0.29 was abstracting the router API without any real value. We now expose the pubsub router API directly and have a test suite in the [interface-pubsub](https://github.com/libp2p/js-libp2p-interfaces/tree/master/src/pubsub) to guarantee routers compliance.

**Before**

```js
libp2p.pubsub._pubsub.*
libp2p.pubsub._pubsub.topicValidators.set(topic, validator)
```

**After**

```js
libp2p.pubsub.*
libp2p.pubsub.topicValidators.set(topic, validator)
```

#### Publish

Publish uses `Uint8Array` data instead of `Buffer`.

**Before**

```js
const topic = 'topic'
const data = Buffer.from('data')

await libp2p.pubsub.publish(topic, data)	
```

**After**

```js
const topic = 'topic'
const data = uint8ArrayFromString('data')

await libp2p.pubsub.publish(topic, data)	
```

#### Subscribe

Handlers should not be directly bound to the subscription anymore.
Message data is now a `Uint8Array` instead of `Buffer`.

**Before**

```js
const topic = 'topic'
const handler = (msg) => {
  // msg.data - pubsub data received
  const data = msg.data.toString()
}
libp2p.pubsub.subscribe(topic, handler)
```

**After**

```js
const topic = 'topic'
const handler = (msg) => {
  // msg.data - pubsub data received
  const data = uint8ArrayToString(msg.data)
}
libp2p.pubsub.on(topic, handler)
libp2p.pubsub.subscribe(topic)
```

#### Unsubscribe

Handlers should not be directly bound to the subscription anymore.

**Before**

```js
const topic = 'topic'
const handler = (msg) => {
  // msg.data - pubsub data received
}
libp2p.pubsub.unsubscribe(topic, handler)
```

**After**

```js
const topic = 'topic'
const handler = (msg) => {
  // msg.data - pubsub data received
}
libp2p.pubsub.removeListener(topic, handler)
libp2p.pubsub.unsubscribe(topic)
```

#### Topic Validators

The validator function does not include the peer parameter anymore. It was redundant since it is included in the message and it could lead to issues as the peer that sent the message might not be the one who created the message in first place. The validator function should also throw an error instead of returning `false` when the message is not valid.

**Before**

```js
const validator = (msgTopic, peer, msg) => {
  // process message
  return false
}
libp2p.pubsub._pubsub.topicValidators.set(topic, validator)
```

**After**

```js
const validator = (msgTopic, msg) => {
  const from = msg.from
  // process message
  throw new Error('not a valid message')
}
libp2p.pubsub.topicValidators.set(topic, validator)
```

### Uint8Arrays replace node Buffers

Aiming to improve libp2p browser support, we are moving away from node core modules unless we can guarantee that the code we are writing will not run in a browser. It is worth to mention that modern JavaScript runtimes have TypedArrays such as Uint8Array backed by ArrayBuffers.



## Module Updates

With this release you should update the following libp2p modules if you are relying on them:

<!--Specify module versions in JSON for migration below.
It's recommended to check package.json changes for this: 
`git diff <release> <prev> -- package.json`
-->

```json

```
